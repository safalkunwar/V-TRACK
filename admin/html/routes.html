<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Management - V-TRACK Admin</title>
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .route-management {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e8eaed;
        }

        .route-header h1 {
            color: #1a73e8;
            font-size: 28px;
            font-weight: 600;
        }

        .add-route-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .add-route-btn:hover {
            background: #1557b0;
        }

        .route-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .route-form {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .route-form h3 {
            color: #202124;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .waypoint-list {
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .waypoint-item:last-child {
            margin-bottom: 0;
        }

        .waypoint-info {
            flex: 1;
        }

        .waypoint-name {
            font-weight: 500;
            color: #202124;
        }

        .waypoint-coords {
            font-size: 12px;
            color: #5f6368;
        }

        .remove-waypoint {
            background: #ea4335;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-waypoint-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 12px;
        }

        .route-map {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .route-map h3 {
            color: #202124;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #routeMap {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid #e8eaed;
        }

        .route-list {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            grid-column: 1 / -1;
        }

        .route-list h3 {
            color: #202124;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .route-table {
            width: 100%;
            border-collapse: collapse;
        }

        .route-table th,
        .route-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e8eaed;
        }

        .route-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #5f6368;
        }

        .route-table tr:hover {
            background: #f8f9fa;
        }

        .route-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .edit-btn {
            background: #1a73e8;
            color: white;
        }

        .delete-btn {
            background: #ea4335;
            color: white;
        }

        .view-btn {
            background: #34a853;
            color: white;
        }

        .status-active {
            color: #34a853;
            font-weight: 500;
        }

        .status-inactive {
            color: #ea4335;
            font-weight: 500;
        }

        .save-route-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .save-route-btn:hover {
            background: #1557b0;
        }

        .save-route-btn:disabled {
            background: #e8eaed;
            color: #5f6368;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .route-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="route-management">
        <div class="route-header">
            <h1><i class="fas fa-route"></i> Route Management</h1>
            <button class="add-route-btn" onclick="openRouteForm()">
                <i class="fas fa-plus"></i>
                Add New Route
            </button>
        </div>

        <div class="route-grid">
            <!-- Route Form -->
            <div class="route-form" id="routeForm" style="display: none;">
                <h3>Route Configuration</h3>
                <form id="newRouteForm">
                    <div class="form-group">
                        <label for="routeId">Route ID</label>
                        <input type="text" id="routeId" name="routeId" placeholder="e.g., BUS001" required>
                    </div>

                    <div class="form-group">
                        <label for="routeName">Route Name</label>
                        <input type="text" id="routeName" name="routeName" placeholder="e.g., Central - University Route" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startLocation">Start Location</label>
                            <input type="text" id="startLocation" name="startLocation" placeholder="e.g., Central Colombo" required>
                        </div>
                        <div class="form-group">
                            <label for="endLocation">End Location</label>
                            <input type="text" id="endLocation" name="endLocation" placeholder="e.g., University of Colombo" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="estimatedDistance">Estimated Distance (km)</label>
                            <input type="number" id="estimatedDistance" name="estimatedDistance" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="estimatedTime">Estimated Time (minutes)</label>
                            <input type="number" id="estimatedTime" name="estimatedTime" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="routeDescription">Route Description</label>
                        <textarea id="routeDescription" name="routeDescription" rows="3" placeholder="Describe the route, major stops, etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Waypoints</label>
                        <div class="waypoint-list" id="waypointList">
                            <div style="text-align: center; color: #5f6368; padding: 20px;">
                                No waypoints added yet
                            </div>
                        </div>
                        <button type="button" class="add-waypoint-btn" onclick="addWaypoint()">
                            <i class="fas fa-plus"></i> Add Waypoint
                        </button>
                    </div>

                    <button type="submit" class="save-route-btn">
                        <i class="fas fa-save"></i> Save Route
                    </button>
                </form>
            </div>

            <!-- Route Map -->
            <div class="route-map">
                <h3>Route Preview</h3>
                <div id="routeMap"></div>
            </div>
        </div>

        <!-- Route List -->
        <div class="route-list">
            <h3>Existing Routes</h3>
            <table class="route-table">
                <thead>
                    <tr>
                        <th>Route ID</th>
                        <th>Route Name</th>
                        <th>Start Location</th>
                        <th>End Location</th>
                        <th>Distance</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="routeTableBody">
                    <!-- Routes will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZpFhPq1pFpvTmyndOnA6SRs9_ftb4jfI&libraries=places&callback=initGoogleMaps" async defer></script>
    
    <script>
        // Route Management System
        class RouteManager {
            constructor() {
                this.map = null;
                this.routes = {};
                this.currentRoute = null;
                this.waypoints = [];
                this.firebaseManager = null;
                
                this.initializeMap();
                this.initializeFirebase();
                this.loadRoutes();
            }

            initializeMap() {
                // Initialize Leaflet map
                this.map = L.map('routeMap').setView([6.9271, 79.8612], 13); // Colombo, Sri Lanka

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(this.map);
            }

            initializeFirebase() {
                // Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyBZpFhPq1pFpvTmyndOnA6SRs9_ftb4jfI",
                    authDomain: "v-track-gu999.firebaseapp.com",
                    databaseURL: "https://v-track-gu999-default-rtdb.firebaseio.com",
                    projectId: "v-track-gu999",
                    storageBucket: "v-track-gu999.appspot.com",
                    messagingSenderId: "1046512747961",
                    appId: "1:1046512747961:web:80df40c48bca3159296268",
                    measurementId: "G-38X29VT1YT"
                };

                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    this.firebaseManager = firebase.database();
                    console.log('Firebase initialized for route management');
                } catch (error) {
                    console.warn('Firebase initialization failed:', error);
                }
            }

            loadRoutes() {
                if (this.firebaseManager) {
                    this.firebaseManager.ref('BusRoutes').once('value', (snapshot) => {
                        const routes = snapshot.val();
                        if (routes) {
                            this.routes = routes;
                            this.displayRoutes();
                        }
                    });
                } else {
                    // Load mock routes
                    this.routes = {
                        'BUS001': {
                            name: 'Central - University Route',
                            startLocation: 'Central Colombo',
                            endLocation: 'University of Colombo',
                            distance: 3.2,
                            time: 15,
                            description: 'Route from central Colombo to University campus',
                            waypoints: [
                                { name: 'Central Bus Station', lat: 6.9271, lng: 79.8612 },
                                { name: 'University of Colombo', lat: 6.9020, lng: 79.8607 }
                            ],
                            status: 'active'
                        },
                        'BUS002': {
                            name: 'Hospital - Mall Route',
                            startLocation: 'Central Colombo',
                            endLocation: 'Odel Shopping Mall',
                            distance: 3.8,
                            time: 18,
                            description: 'Route from central area to shopping mall',
                            waypoints: [
                                { name: 'Central Bus Station', lat: 6.9271, lng: 79.8612 },
                                { name: 'Odel Shopping Mall', lat: 6.9147, lng: 79.8587 }
                            ],
                            status: 'active'
                        }
                    };
                    this.displayRoutes();
                }
            }

            displayRoutes() {
                const tbody = document.getElementById('routeTableBody');
                if (!tbody) return;

                tbody.innerHTML = Object.keys(this.routes).map(routeId => {
                    const route = this.routes[routeId];
                    return `
                        <tr>
                            <td>${routeId}</td>
                            <td>${route.name}</td>
                            <td>${route.startLocation}</td>
                            <td>${route.endLocation}</td>
                            <td>${route.distance} km</td>
                            <td><span class="status-${route.status}">${route.status}</span></td>
                            <td>
                                <div class="route-actions">
                                    <button class="action-btn view-btn" onclick="routeManager.viewRoute('${routeId}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn edit-btn" onclick="routeManager.editRoute('${routeId}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="routeManager.deleteRoute('${routeId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            openRouteForm(routeId = null) {
                const form = document.getElementById('routeForm');
                form.style.display = 'block';

                if (routeId) {
                    // Edit existing route
                    this.currentRoute = routeId;
                    this.populateForm(this.routes[routeId]);
                } else {
                    // New route
                    this.currentRoute = null;
                    this.clearForm();
                }
            }

            populateForm(route) {
                document.getElementById('routeId').value = route.id || '';
                document.getElementById('routeName').value = route.name || '';
                document.getElementById('startLocation').value = route.startLocation || '';
                document.getElementById('endLocation').value = route.endLocation || '';
                document.getElementById('estimatedDistance').value = route.distance || '';
                document.getElementById('estimatedTime').value = route.time || '';
                document.getElementById('routeDescription').value = route.description || '';

                this.waypoints = route.waypoints || [];
                this.displayWaypoints();
            }

            clearForm() {
                document.getElementById('newRouteForm').reset();
                this.waypoints = [];
                this.displayWaypoints();
            }

            addWaypoint() {
                const name = prompt('Enter waypoint name:');
                if (!name) return;

                const lat = prompt('Enter latitude:');
                const lng = prompt('Enter longitude:');
                
                if (lat && lng) {
                    this.waypoints.push({
                        name: name,
                        lat: parseFloat(lat),
                        lng: parseFloat(lng)
                    });
                    this.displayWaypoints();
                    this.updateMap();
                }
            }

            displayWaypoints() {
                const waypointList = document.getElementById('waypointList');
                if (!waypointList) return;

                if (this.waypoints.length === 0) {
                    waypointList.innerHTML = '<div style="text-align: center; color: #5f6368; padding: 20px;">No waypoints added yet</div>';
                    return;
                }

                waypointList.innerHTML = this.waypoints.map((waypoint, index) => `
                    <div class="waypoint-item">
                        <div class="waypoint-info">
                            <div class="waypoint-name">${waypoint.name}</div>
                            <div class="waypoint-coords">${waypoint.lat}, ${waypoint.lng}</div>
                        </div>
                        <button type="button" class="remove-waypoint" onclick="routeManager.removeWaypoint(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }

            removeWaypoint(index) {
                this.waypoints.splice(index, 1);
                this.displayWaypoints();
                this.updateMap();
            }

            updateMap() {
                // Clear existing markers and polylines
                this.map.eachLayer((layer) => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        this.map.removeLayer(layer);
                    }
                });

                if (this.waypoints.length > 0) {
                    // Add markers for waypoints
                    this.waypoints.forEach((waypoint, index) => {
                        L.marker([waypoint.lat, waypoint.lng])
                            .addTo(this.map)
                            .bindPopup(`<b>${waypoint.name}</b><br>Waypoint ${index + 1}`)
                            .openPopup();
                    });

                    // Create polyline connecting waypoints
                    const coordinates = this.waypoints.map(wp => [wp.lat, wp.lng]);
                    if (coordinates.length > 1) {
                        L.polyline(coordinates, {
                            color: '#1a73e8',
                            weight: 4,
                            opacity: 0.8
                        }).addTo(this.map);

                        // Fit map to show all waypoints
                        this.map.fitBounds(coordinates);
                    }
                }
            }

            saveRoute() {
                const formData = new FormData(document.getElementById('newRouteForm'));
                const routeData = {
                    id: formData.get('routeId'),
                    name: formData.get('routeName'),
                    startLocation: formData.get('startLocation'),
                    endLocation: formData.get('endLocation'),
                    distance: parseFloat(formData.get('estimatedDistance')),
                    time: parseInt(formData.get('estimatedTime')),
                    description: formData.get('routeDescription'),
                    waypoints: this.waypoints,
                    status: 'active',
                    createdAt: Date.now()
                };

                if (this.firebaseManager) {
                    // Save to Firebase
                    this.firebaseManager.ref(`BusRoutes/${routeData.id}`).set(routeData)
                        .then(() => {
                            this.routes[routeData.id] = routeData;
                            this.displayRoutes();
                            this.closeRouteForm();
                            alert('Route saved successfully!');
                        })
                        .catch((error) => {
                            console.error('Error saving route:', error);
                            alert('Error saving route. Please try again.');
                        });
                } else {
                    // Save locally
                    this.routes[routeData.id] = routeData;
                    this.displayRoutes();
                    this.closeRouteForm();
                    alert('Route saved successfully!');
                }
            }

            closeRouteForm() {
                document.getElementById('routeForm').style.display = 'none';
                this.currentRoute = null;
                this.waypoints = [];
            }

            viewRoute(routeId) {
                const route = this.routes[routeId];
                if (!route) return;

                this.waypoints = route.waypoints || [];
                this.updateMap();
                
                // Show route info
                const info = `
                    <div style="padding: 10px;">
                        <h4>${route.name}</h4>
                        <p><strong>Start:</strong> ${route.startLocation}</p>
                        <p><strong>End:</strong> ${route.endLocation}</p>
                        <p><strong>Distance:</strong> ${route.distance} km</p>
                        <p><strong>Time:</strong> ${route.time} minutes</p>
                        <p><strong>Description:</strong> ${route.description}</p>
                    </div>
                `;

                // Create popup with route info
                const center = this.calculateRouteCenter(this.waypoints);
                L.popup()
                    .setLatLng(center)
                    .setContent(info)
                    .openOn(this.map);
            }

            editRoute(routeId) {
                this.openRouteForm(routeId);
            }

            deleteRoute(routeId) {
                if (confirm('Are you sure you want to delete this route?')) {
                    if (this.firebaseManager) {
                        this.firebaseManager.ref(`BusRoutes/${routeId}`).remove()
                            .then(() => {
                                delete this.routes[routeId];
                                this.displayRoutes();
                                alert('Route deleted successfully!');
                            })
                            .catch((error) => {
                                console.error('Error deleting route:', error);
                                alert('Error deleting route. Please try again.');
                            });
                    } else {
                        delete this.routes[routeId];
                        this.displayRoutes();
                        alert('Route deleted successfully!');
                    }
                }
            }

            calculateRouteCenter(waypoints) {
                if (waypoints.length === 0) return [6.9271, 79.8612];
                
                const latSum = waypoints.reduce((sum, wp) => sum + wp.lat, 0);
                const lngSum = waypoints.reduce((sum, wp) => sum + wp.lng, 0);
                return [latSum / waypoints.length, lngSum / waypoints.length];
            }
        }

        // Initialize route manager
        let routeManager;

        function initGoogleMaps() {
            console.log('Google Maps API loaded for route management');
        }

        function openRouteForm() {
            routeManager.openRouteForm();
        }

        function addWaypoint() {
            routeManager.addWaypoint();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            routeManager = new RouteManager();

            // Handle form submission
            document.getElementById('newRouteForm').addEventListener('submit', (e) => {
                e.preventDefault();
                routeManager.saveRoute();
            });
        });
    </script>
</body>
</html> 