<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-container {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bus-status-item, .route-item, .schedule-item, .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .bus-info, .route-info {
            margin-bottom: 10px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .status.on-time { background: #d4edda; color: #155724; }
        .status.delayed { background: #f8d7da; color: #721c24; }

        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <div class="logo">
                <img src="../images/logo.png" alt="Logo" class="logo">
            </div>
            <div class="nav-links">
                <a href="miniindex.html">Home</a>
                <a href="userdashboard.html" class="active">Dashboard</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </nav>

        <div class="dashboard-container">
            <!-- Bus Status -->
            <div class="dashboard-card">
                <h3><i class="fas fa-bus"></i> Live Bus Status</h3>
                <div id="liveBusStatus">
                    <div class="loading">Loading bus status...</div>
                </div>
            </div>

            <!-- Route Information -->
            <div class="dashboard-card">
                <h3><i class="fas fa-route"></i> My Routes</h3>
                <div id="userRoutes">
                    <div class="loading">Loading routes...</div>
                </div>
            </div>

            <!-- Schedule -->
            <div class="dashboard-card">
                <h3><i class="fas fa-clock"></i> Today's Schedule</h3>
                <div id="busSchedule">
                    <div class="loading">Loading schedule...</div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="dashboard-card">
                <h3><i class="fas fa-bell"></i> Recent Updates</h3>
                <div id="userNotifications">
                    <div class="loading">Loading updates...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBZpFhPq1pFpvTmyndOnA6SRs9_ftb4jfI",
            authDomain: "v-track-gu999.firebaseapp.com",
            databaseURL: "https://v-track-gu999-default-rtdb.firebaseio.com",
            projectId: "v-track-gu999",
            storageBucket: "v-track-gu999.appspot.com",
            messagingSenderId: "1046512747961",
            appId: "1:1046512747961:web:80df40c48bca3159296268",
            measurementId: "G-38X29VT1YT"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const database = firebase.database();

        // Check authentication
        auth.onAuthStateChanged(function(user) {
            if (!user) {
                window.location.href = '../index.html';
            }
        });

        // Load dashboard data
        document.addEventListener('DOMContentLoaded', () => {
            loadLiveBusStatus();
            loadUserRoutes();
            loadBusSchedule();
            loadNotifications();
        });

        function loadLiveBusStatus() {
            const container = document.getElementById('liveBusStatus');
            database.ref('BusLocation').on('value', snapshot => {
                container.innerHTML = '';
                snapshot.forEach(child => {
                    const busData = child.val();
                    const timestamps = Object.keys(busData);
                    const latestData = busData[timestamps[timestamps.length - 1]];
                    
                    container.innerHTML += `
                        <div class="bus-status-item">
                            <div class="bus-info">
                                <h4>Bus ${child.key}</h4>
                                <p>Last Updated: ${new Date(parseInt(timestamps[timestamps.length - 1])).toLocaleTimeString()}</p>
                            </div>
                            <button onclick="window.location.href='miniindex.html?bus=${child.key}'">
                                Track on Map
                            </button>
                        </div>
                    `;
                });
            });
        }

        function loadUserRoutes() {
            const container = document.getElementById('userRoutes');
            database.ref('busDetails').once('value', snapshot => {
                container.innerHTML = '';
                snapshot.forEach(child => {
                    const bus = child.val();
                    container.innerHTML += `
                        <div class="route-item">
                            <div class="route-info">
                                <h4>${bus.busName}</h4>
                                <p>${bus.busRoute || 'Route not specified'}</p>
                            </div>
                            <button onclick="window.location.href='miniindex.html?bus=${bus.busName}'">
                                View Route
                            </button>
                        </div>
                    `;
                });
            });
        }

        function loadBusSchedule() {
            const container = document.getElementById('busSchedule');
            database.ref('busDetails').once('value', snapshot => {
                container.innerHTML = '';
                snapshot.forEach(child => {
                    const bus = child.val();
                    container.innerHTML += `
                        <div class="schedule-item">
                            <div class="route-info">
                                <h4>${bus.busName}</h4>
                                <p>${bus.busRoute || 'Route not specified'}</p>
                            </div>
                            <div class="status on-time">Active</div>
                        </div>
                    `;
                });
            });
        }

        function loadNotifications() {
            const container = document.getElementById('userNotifications');
            database.ref('notices').orderByChild('timestamp').limitToLast(5).on('value', snapshot => {
                container.innerHTML = '';
                const notices = [];
                snapshot.forEach(child => {
                    notices.unshift(child.val());
                });
                
                notices.forEach(notice => {
                    container.innerHTML += `
                        <div class="notification-item">
                            <p>${notice.content}</p>
                            <small>${new Date(notice.timestamp).toLocaleString()}</small>
                        </div>
                    `;
                });

                if (notices.length === 0) {
                    container.innerHTML = '<p>No recent notifications</p>';
                }
            });
        }

        function logout() {
            auth.signOut().then(() => {
                window.location.href = '../index.html';
            }).catch((error) => {
                console.error('Error logging out:', error);
            });
        }
    </script>
</body>
</html> 